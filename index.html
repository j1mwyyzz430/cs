<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSC æ™ºèƒ½èªå¢ƒè¾¨éŸ³ç‰¹è¨“ (é€²åº¦è¿½è¹¤ç‰ˆ)</title>
    <style>
        /* ==================== 
           1. è¦–è¦ºé¢¨æ ¼è¨­ç½® (æ·±ç©ºè­·çœ¼æ¨¡å¼)
           ==================== */
        :root {
            --bg-color: #0f1319;       /* æ·±ç©ºè—é»‘ */
            --card-bg: rgba(23, 32, 42, 0.95); /* å¡ç‰‡èƒŒæ™¯ */
            --text-primary: #ecf0f1;   
            --text-secondary: #bdc3c7; 
            --accent-color: #e74c3c;   /* éŒ¯èª¤ç´… */
            --success-color: #2ecc71;  /* æ­£ç¢ºç¶  */
            --highlight-color: #f1c40f; /* é‡é»é«˜äº®(é‡‘é»ƒ) */
            --btn-next: #d35400;       
        }

        body {
            font-family: "Microsoft YaHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•æ¢ */
        }

        #star-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .container {
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            width: 90%;
            max-width: 650px;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 10;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background-color: #2c3e50;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--highlight-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* é¡Œç›®é¡¯ç¤º */
        .word-display {
            font-size: 50px;
            font-weight: bold;
            margin: 20px 0 40px 0;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            min-height: 70px;
        }

        .target-char {
            color: var(--highlight-color);
            font-size: 65px;
            border-bottom: 4px solid var(--highlight-color);
            padding-bottom: 5px;
            display: inline-block;
        }

        /* é¸é …æŒ‰éˆ• */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button.option-btn {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid #576574;
            color: var(--text-primary);
            border-radius: 12px;
            padding: 15px;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: Arial, sans-serif;
        }

        button.option-btn:hover:not(:disabled) {
            border-color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        button.option-btn.correct {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: #fff;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
        }

        button.option-btn.wrong {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
            opacity: 0.6;
        }

        /* åé¥‹å€åŸŸ */
        .feedback-area {
            min-height: 100px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .feedback-note {
            color: #81a1c1;
            font-size: 16px;
            margin-top: 8px;
            display: block;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            line-height: 1.5;
            max-width: 95%;
        }

        .btn-next-q {
            background-color: var(--btn-next);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            display: none; /* é»˜èªéš±è— */
            box-shadow: 0 4px 15px rgba(211, 84, 0, 0.4);
            animation: popIn 0.3s ease;
        }
        .btn-next-q:hover { background-color: #e67e22; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* çµç®—ç•«é¢ */
        .result-screen { display: none; }
        
        .score-circle {
            width: 140px; height: 140px;
            border-radius: 50%;
            border: 6px solid var(--success-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 48px; font-weight: bold;
            margin: 0 auto 20px;
            color: var(--text-primary);
        }

        /* æ–°å¢ï¼šç¸½é€²åº¦å±•ç¤ºå€ */
        .mastery-stats-box {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .mastery-label {
            display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #bdc3c7;
        }
        .mastery-bar {
            height: 10px; background: #34495e; border-radius: 5px; overflow: hidden;
        }
        .mastery-fill {
            height: 100%; background: linear-gradient(90deg, #f1c40f, #2ecc71); width: 0%; transition: width 1s ease-out;
        }
        .mastery-details {
            margin-top: 10px; font-size: 13px; color: #7f8c8d; text-align: center;
        }

        .review-list {
            text-align: left;
            max-height: 250px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
            border-top: 1px solid #34495e;
        }
        .review-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 16px;
        }
        
        .btn-restart {
            background-color: #2980b9; color: white; border: none;
            padding: 15px 40px; border-radius: 8px; font-size: 18px; cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .btn-restart:hover { background-color: #3498db; }
        
        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a252f; }
        ::-webkit-scrollbar-thumb { background: #34495e; border-radius: 4px; }

    </style>
</head>
<body>

<canvas id="star-canvas"></canvas>

<div class="container">
    <div id="game-screen">
        <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">PSC èªå¢ƒè¾¨éŸ³ç‰¹è¨“ | æ™ºèƒ½æ¨¡å¼</div>
        <div style="font-size: 16px; color: var(--highlight-color); margin-bottom: 15px;">
            è«‹é¸å‡º<span style="border-bottom: 2px solid var(--highlight-color);">é»ƒè‰²å­—</span>çš„æ­£ç¢ºè®€éŸ³
        </div>
        
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-fill" id="session-progress"></div>
            </div>
        </div>

        <div class="word-display" id="question-word">è¼‰å…¥ä¸­...</div>

        <div class="options-grid" id="options-container"></div>

        <div class="feedback-area" id="feedback-box">
            <div id="feedback-text"></div>
            </div>
    </div>

    <div id="result-screen" class="result-screen">
        <h2 style="color:#fff; margin-top:0;">ç‰¹è¨“çµæŸ</h2>
        
        <div class="score-circle" id="final-score">0</div>
        <p id="eval-text" style="color:#bdc3c7; margin-bottom: 15px;">...</p>
        
        <div class="mastery-stats-box">
            <div class="mastery-label">
                <span>ç¸½é¡Œåº«æŒæ¡åº¦ (é€£çºŒç­”å°3æ¬¡)</span>
                <span id="mastery-percentage">0%</span>
            </div>
            <div class="mastery-bar">
                <div class="mastery-fill" id="mastery-bar-fill"></div>
            </div>
            <div class="mastery-details" id="mastery-count-text">
                å·²ç²¾é€š 0 / 200 å­—
            </div>
        </div>

        <div style="text-align:left; color:#f1c40f; font-size:14px; margin-top:15px;">
            ğŸ“ æœ¬å±€éŒ¯é¡Œå›é¡§ (å·²åŠ å…¥å¾©ä»‡æ¸…å–®)ï¼š
        </div>
        <div class="review-list" id="review-container"></div>
        
        <button class="btn-restart" onclick="initGame()">å†ä¾†ä¸€å±€ (å„ªå…ˆè¤‡ç¿’éŒ¯é¡Œ) ğŸ”„</button>
        <button style="background:transparent; border:none; color:#576574; font-size:12px; margin-top:10px; cursor:pointer; text-decoration:underline;" onclick="resetAllData()">âš ï¸ é‡ç½®æ‰€æœ‰å­¸ç¿’è¨˜éŒ„</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. æ ¸å¿ƒé¡Œåº« (å·²ç‚ºä½ æ“´å……äº†å¤§é‡æ˜“éŒ¯å­—)
    // ==========================================
    const fullQuestionBank = [
        { word: "é˜¿", context: "é˜¿å§¨", pinyin: "Ä", options: ["Ä“", "a", "Ã¡"], note: "ç¨±å‘¼å¸¸ç”¨ Äã€‚é˜¿è† è®€ Ä“ã€‚" },
        { word: "é˜¿", context: "é˜¿è† ", pinyin: "Ä“", options: ["Ä", "a", "Ã¡"], note: "è—¥åè®€ Ä“ã€‚" },
        { word: "æŒ¨", context: "æŒ¨è¿‘", pinyin: "Äi", options: ["Ã¡i", "Ã i", "Ä"], note: "é è¿‘è®€ Äi (ä¸€è²)ã€‚" },
        { word: "æŒ¨", context: "æŒ¨æ‰“", pinyin: "Ã¡i", options: ["Äi", "Ã i", "Ã "], note: "å—è‹¦/æ‹–å»¶è®€ Ã¡i (äºŒè²)ã€‚" },
        { word: "æš«", context: "æš«æ™‚", pinyin: "zÃ n", options: ["zhÃ n", "zÃ¡n", "chÃ n"], note: "å››è²å¹³èˆŒ zÃ nã€‚å‹¿è®€ zhÃ nã€‚" },
        { word: "æ°›", context: "æ°£æ°›", pinyin: "fÄ“n", options: ["fÃ¨n", "fÄ“ng", "pÄ“n"], note: "ä¸€è² fÄ“nã€‚å‹¿è®€ fÃ¨nã€‚" },
        { word: "æª”", context: "æª”æ¡ˆ", pinyin: "dÃ ng", options: ["dÇng", "dÄng", "tÃ³ng"], note: "å››è² dÃ ngã€‚å‹¿è®€ dÇngã€‚" },
        { word: "é…µ", context: "ç™¼é…µ", pinyin: "jiÃ o", options: ["xiÃ o", "xiÄo", "gÄo"], note: "å¿…è€ƒï¼è®€ jiÃ oã€‚" },
        { word: "èª¼", context: "å‹èª¼", pinyin: "yÃ¬", options: ["yÃ­", "yÄ«", "yÃ¬ng"], note: "å››è² yÃ¬ã€‚" },
        { word: "åº‡", context: "åŒ…åº‡", pinyin: "bÃ¬", options: ["pÃ¬", "bÃ¬ng", "pÄ«"], note: "å››è² bÃ¬ã€‚" },
        { word: "ç€•", context: "ç€•è‡¨", pinyin: "bÄ«n", options: ["pÃ­n", "bÄ«ng", "pÄ«n"], note: "ä¸€è² bÄ«nã€‚å‹¿è®€ pÃ­nã€‚" },
        { word: "ç¨±", context: "ç¨±è·", pinyin: "chÃ¨n", options: ["chÄ“ng", "chÃ¨ng", "cÃ¨n"], note: "åˆé©è®€ chÃ¨nã€‚ç¨±è®šè®€ chÄ“ngã€‚" },
        { word: "ä¹˜", context: "åƒä¹˜ä¹‹åœ‹", pinyin: "shÃ¨ng", options: ["chÃ©ng", "chÃ¨ng", "shÄ“ng"], note: "å¤é‡è©(è»Š)è®€ shÃ¨ngã€‚ä¹˜è»Šè®€ chÃ©ngã€‚" },
        { word: "å¼„", context: "å¼„å ‚", pinyin: "lÃ²ng", options: ["nÃ²ng", "nÃ¨ng", "lÅng"], note: "å··å­è®€ lÃ²ngã€‚ç©å¼„è®€ nÃ²ngã€‚" },
        { word: "å¼·", context: "å¼·è¿«", pinyin: "qiÇng", options: ["qiÃ¡ng", "jiÃ ng", "qiÄng"], note: "å‹‰å¼·åˆ¥äººè®€ qiÇngã€‚" },
        { word: "çµ¦", context: "çµ¦äºˆ", pinyin: "jÇ", options: ["gÄ›i", "yÇ”", "jÃ­"], note: "æ›¸é¢èª/ä¾›æ‡‰è®€ jÇã€‚çµ¦ä½ (å£èª)è®€ gÄ›iã€‚" },
        { word: "è™•", context: "è™•åˆ†", pinyin: "chÇ”", options: ["chÃ¹", "cÇ”", "shÃ¹"], note: "å‹•è©(è™•ç½®)è®€ chÇ”ã€‚åœ°æ–¹è®€ chÃ¹ã€‚" },
        { word: "å·®", context: "å‡ºå·®", pinyin: "chÄi", options: ["chÄ", "chÃ ", "cÄ«"], note: "æ´¾é£è®€ chÄiã€‚å·®åˆ¥è®€ chÄã€‚" },
        { word: "æ ¡", context: "æ ¡å°", pinyin: "jiÃ o", options: ["xiÃ o", "xiÄo", "jiÄo"], note: "è¨‚æ­£è®€ jiÃ oã€‚å­¸æ ¡è®€ xiÃ oã€‚" },
        { word: "å‰µ", context: "å‰µå‚·", pinyin: "chuÄng", options: ["chuÃ ng", "cÄng", "shuÄng"], note: "å‚·å£è®€ chuÄngã€‚å‰µé€ è®€ chuÃ ngã€‚" },
        { word: "æ½›", context: "æ½›æ°´", pinyin: "qiÃ¡n", options: ["qiÇn", "jiÄn", "zÃ n"], note: "äºŒè²ï¼å‹¿è®€ä¸‰è²ã€‚" },
        { word: "æ¡†", context: "é–€æ¡†", pinyin: "kuÃ ng", options: ["kuÄng", "guÄng", "kÄng"], note: "å››è²ï¼å‹¿è®€ä¸€è²ã€‚" },
        { word: "å’¯", context: "å’¯è¡€", pinyin: "kÇ", options: ["luÃ²", "gÄ“", "lo"], note: "å’¯(kÇ)è¡€ï¼Œå‹¿è®€ luÃ²ã€‚" },
        { word: "æ„", context: "æ„æ‹³é ­", pinyin: "lÅ«n", options: ["lÃºn", "lÃ¹n", "qiÇng"], note: "ä¸€è²ï¼" },
        { word: "éŸ‹", context: "éŸ‹æ°", pinyin: "wÃ©i", options: ["wÄ›i", "huÃ¬", "wÄ“i"], note: "äºŒè²ï¼å‹¿è®€ä¸‰è²ï¼Œå§“æ°ã€‚" },
        { word: "è†", context: "è†è“‹", pinyin: "xÄ«", options: ["qÄ«", "xÃ­", "yÃ¬"], note: "å‹¿è®€ 'ä¸ƒ'ã€‚" },
        { word: "ç©´", context: "ç©´ä½", pinyin: "xuÃ©", options: ["xuÃ¨", "xuÄ›", "kÅng"], note: "äºŒè²ï¼å‹¿è®€å››è²ã€‚" },
        { word: "äº", context: "äºæ´²", pinyin: "yÃ ", options: ["yÇ", "Ã ", "yÄ"], note: "å››è²ï¼å»£æ±äººå¸¸èª¤è®€ä¸‰è²ã€‚" },
        { word: "å’±", context: "å’±å€‘", pinyin: "zÃ¡n", options: ["zÃ¡", "zÄ", "zhÃ¡n"], note: "äºŒè²ï¼" },
        { word: "ç¶»", context: "ç ´ç¶»", pinyin: "zhÃ n", options: ["dÃ¬ng", "dian", "zhÄn"], note: "å‹¿è®€ 'å®š'ã€‚" },
        { word: "è„‚", context: "è„‚è‚ª", pinyin: "zhÄ«", options: ["zhÇ", "zÄ«", "zhÃ¬"], note: "ä¸€è²ï¼å‹¿è®€ä¸‰è²ã€‚" },
        { word: "è²¯", context: "è²¯å­˜", pinyin: "zhÃ¹", options: ["chÇ”", "zhÇ”", "nÃ­ng"], note: "å››è²ï¼å‹¿è®€ä¸‰è²ã€‚" },
        { word: "ç¶œ", context: "ç¶œåˆ", pinyin: "zÅng", options: ["zÃ²ng", "cÅng", "zhÅng"], note: "ä¸€è²ï¼å‹¿è®€å››è²ã€‚" },
        { word: "å¦", context: "å¦æ¥µæ³°ä¾†", pinyin: "pÇ", options: ["fÇ’u", "bÃ¬", "pÄ«"], note: "å£é‹æ°£åˆ°é ­è®€ pÇã€‚" },
        { word: "ç­”", context: "ç­”æ‡‰", pinyin: "dÄ", options: ["dÃ¡", "tÄ", "dÃ "], note: "æ‡‰å…è®€ dÄã€‚å›ç­”è®€ dÃ¡ã€‚" },
        { word: "æ®¼", context: "åœ°æ®¼", pinyin: "qiÃ o", options: ["kÃ©", "qiÃ ", "hÃº"], note: "åœ°çƒè¡¨å±¤è®€ qiÃ oã€‚è²æ®¼è®€ kÃ©ã€‚" }
        // *** é€™è£¡å¯ä»¥ç¹¼çºŒæ·»åŠ æ›´å¤šé¡Œç›® ***
    ];

    // ==========================================
    // 2. æ™ºèƒ½æ•¸æ“šåº«ç®¡ç† (Local Storage)
    // ==========================================
    const STORAGE_KEY = 'psc_mastery_v2'; // ç‰ˆæœ¬è™Ÿæ§åˆ¶

    // ç²å–æ•¸æ“š
    function getStoredData() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : {};
    }

    // ä¿å­˜æ•¸æ“š (æ™ºèƒ½åˆ¤æ–·é‚è¼¯)
    function saveAnswerResult(word, context, isCorrect) {
        let stats = getStoredData();
        const key = `${word}_${context}`; // å”¯ä¸€æ¨™è­˜ç¬¦

        if (!stats[key]) {
            stats[key] = { 
                streak: 0,      // é€£çºŒç­”å°æ¬¡æ•¸
                wrongCount: 0,  // æ­·å²éŒ¯èª¤ç¸½æ•¸
                lastWrong: 0    // æœ€å¾Œä¸€æ¬¡ç­”éŒ¯çš„æ™‚é–“æˆ³(å¯ç”¨æ–¼éºå¿˜æ›²ç·šç®—æ³•ï¼Œæ­¤è™•æš«ç°¡åŒ–)
            };
        }

        if (isCorrect) {
            stats[key].streak += 1;
        } else {
            stats[key].streak = 0; // ä¸€æ—¦åšéŒ¯ï¼Œé€£å°æ¸…é›¶
            stats[key].wrongCount += 1;
            stats[key].lastWrong = Date.now();
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
    }

    // è¨ˆç®—ç¸½é«”æŒæ¡åº¦
    function calculateMastery() {
        const stats = getStoredData();
        let masteredCount = 0;

        fullQuestionBank.forEach(item => {
            const key = `${item.word}_${item.context}`;
            if (stats[key] && stats[key].streak >= 3) {
                masteredCount++;
            }
        });

        return {
            mastered: masteredCount,
            total: fullQuestionBank.length,
            percent: Math.round((masteredCount / fullQuestionBank.length) * 100)
        };
    }

    // é‡ç½®æ‰€æœ‰æ•¸æ“š
    function resetAllData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å­¸ç¿’é€²åº¦å’ŒéŒ¯é¡Œè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚")) {
            localStorage.removeItem(STORAGE_KEY);
            alert("å·²é‡ç½®ï¼è«‹é‡æ–°é–‹å§‹ã€‚");
            initGame();
        }
    }

    // ==========================================
    // 3. éŠæˆ²æ ¸å¿ƒé‚è¼¯
    // ==========================================
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let canAnswer = true;
    let sessionMistakes = []; // æœ¬å±€éŒ¯é¡Œ

    // æ´—ç‰Œ
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // ğŸŒŸ æ™ºèƒ½é¸é¡Œç®—æ³• ğŸŒŸ
    function selectQuestions() {
        const stats = getStoredData();
        
        let errorPool = [];    // å¾©ä»‡æ± ï¼šæ›¾ç¶“éŒ¯éä¸”æœªæŒæ¡
        let newPool = [];      // æ–°é¡Œæ± ï¼šæ²’åšéæˆ– streak < 3
        let masteredPool = []; // å®—å¸«æ± ï¼šstreak >= 3

        fullQuestionBank.forEach(item => {
            const key = `${item.word}_${item.context}`;
            const record = stats[key];

            if (record) {
                if (record.streak >= 3) {
                    masteredPool.push(item);
                } else if (record.streak < 3 && record.wrongCount > 0) {
                    errorPool.push(item);
                } else {
                    newPool.push(item); // åšéä½†æ²’éŒ¯éï¼Œé‚„æ²’åˆ°3æ¬¡
                }
            } else {
                newPool.push(item); // å…¨æ–°é¡Œ
            }
        });

        // å„ªå…ˆç´šæ’åºï¼šéŒ¯é¡Œ > æ–°é¡Œ > å·²æŒæ¡é¡Œ
        let selected = [];

        // 1. å„ªå…ˆå¡å…¥éŒ¯é¡Œ (æœ€å¤šå–10é¡Œï¼Œé¿å…æŒ«æ•—æ„Ÿå¤ªå¼·)
        shuffleArray(errorPool);
        selected = selected.concat(errorPool.slice(0, 10));

        // 2. è£œè¶³æ–°é¡Œ
        if (selected.length < 20) {
            shuffleArray(newPool);
            const need = 20 - selected.length;
            selected = selected.concat(newPool.slice(0, need));
        }

        // 3. é‚„æ˜¯ä¸å¤ ï¼Ÿé‚£è¤‡ç¿’ä¸€ä¸‹å·²æŒæ¡çš„ (é˜²æ­¢éºå¿˜)
        if (selected.length < 20) {
            shuffleArray(masteredPool);
            const need = 20 - selected.length;
            selected = selected.concat(masteredPool.slice(0, need));
        }

        // å†æ¬¡æ‰“äº‚é¡Œç›®é †åºï¼Œé¿å…éŒ¯é¡Œç¸½æ˜¯å †åœ¨é–‹é ­
        return shuffleArray(selected.slice(0, 20));
    }

    // åˆå§‹åŒ–éŠæˆ²
    function initGame() {
        // é‡ç½®è®Šé‡
        currentIndex = 0;
        score = 0;
        sessionMistakes = [];
        canAnswer = true;

        // åˆ‡æ›ç•Œé¢
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('result-screen').style.display = 'none';

        // æŠ½å–é¡Œç›®
        currentQuestions = selectQuestions();
        
        // é˜²å‘†ï¼šå¦‚æœé¡Œåº«ç‚ºç©º
        if (currentQuestions.length === 0) {
            alert("é¡Œåº«ç‚ºç©ºï¼è«‹æª¢æŸ¥ä»£ç¢¼ä¸­çš„ fullQuestionBank æ•¸çµ„ã€‚");
            return;
        }

        renderQuestion();
    }

    // æ¸²æŸ“é¡Œç›®
    function renderQuestion() {
        // é€²åº¦æ¢æ›´æ–°
        const progressPercent = (currentIndex / currentQuestions.length) * 100;
        document.getElementById('session-progress').style.width = `${progressPercent}%`;

        // æª¢æŸ¥æ˜¯å¦çµæŸ
        if (currentIndex >= currentQuestions.length) {
            endGame();
            return;
        }

        const q = currentQuestions[currentIndex];

        // é¡¯ç¤ºæ–‡å­— (é«˜äº®)
        const displayHtml = q.context.replace(q.word, `<span class="target-char">${q.word}</span>`);
        document.getElementById('question-word').innerHTML = displayHtml;

        // æ¸…ç©ºèˆŠç‹€æ…‹
        document.getElementById('feedback-box').innerHTML = '<div id="feedback-text"></div>';
        
        // ç”Ÿæˆé¸é …
        let options = [q.pinyin, ...q.options];
        options = shuffleArray(options);

        const container = document.getElementById('options-container');
        container.innerHTML = '';

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = () => handleAnswer(opt, q, btn);
            container.appendChild(btn);
        });

        canAnswer = true;
    }

    // è™•ç†é»æ“Š
    function handleAnswer(selected, question, btnElement) {
        if (!canAnswer) return;
        canAnswer = false;

        const isCorrect = selected === question.pinyin;
        const feedbackBox = document.getElementById('feedback-box');
        
        // è¨˜éŒ„æ•¸æ“šåˆ° LocalStorage
        saveAnswerResult(question.word, question.context, isCorrect);

        // è¦–è¦ºåé¥‹
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(btn => {
            if (btn.textContent === question.pinyin) {
                btn.classList.add('correct');
            } else if (btn.textContent === selected && !isCorrect) {
                btn.classList.add('wrong');
            }
            btn.disabled = true;
        });

        if (isCorrect) {
            score++;
            feedbackBox.innerHTML = `<div id="feedback-text" style="color:var(--success-color); font-weight:bold; font-size:20px;">âœ… å›ç­”æ­£ç¢ºï¼</div>`;
            setTimeout(() => {
                currentIndex++;
                renderQuestion();
            }, 800); // 0.8ç§’å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ
        } else {
            // è¨˜éŒ„æœ¬å±€éŒ¯é¡Œ
            sessionMistakes.push({
                word: question.word,
                context: question.context,
                pinyin: question.pinyin,
                wrong: selected
            });

            feedbackBox.innerHTML = `
                <div id="feedback-text">
                    <span style="color:var(--accent-color); font-weight:bold; font-size:20px;">âŒ éŒ¯èª¤ï¼</span>
                    ${question.note ? `<br><span class="feedback-note">ğŸ’¡ å°ˆå®¶æç¤ºï¼š${question.note}</span>` : ''}
                </div>
                <button class="btn-next-q" onclick="forceNext()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
            `;
            document.querySelector('.btn-next-q').style.display = 'inline-block';
        }
    }

    function forceNext() {
        currentIndex++;
        renderQuestion();
    }

    // éŠæˆ²çµç®—
    function endGame() {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        const totalQ = currentQuestions.length;
        const finalScore = Math.round((score / totalQ) * 100);

        // æ›´æ–°æœ¬å±€åˆ†æ•¸é¡¯ç¤º
        const scoreCircle = document.getElementById('final-score');
        const evalText = document.getElementById('eval-text');
        
        scoreCircle.textContent = finalScore;

        if (finalScore >= 90) {
            scoreCircle.style.borderColor = "#2ecc71";
            evalText.innerHTML = "<strong>ä¸€ç´šä¹™ç­‰æ°´å¹³ï¼</strong><br>èªæ„Ÿæ¥µä½³ï¼Œè«‹ä¿æŒã€‚";
        } else if (finalScore >= 80) {
            scoreCircle.style.borderColor = "#3498db";
            evalText.innerHTML = "<strong>äºŒç´šç”²ç­‰æ°´å¹³ï¼</strong><br>å·²é”æ¨™ï¼Œæ³¨æ„å¾®ç´°éŒ¯èª¤ã€‚";
        } else {
            scoreCircle.style.borderColor = "#e74c3c";
            evalText.innerHTML = "<strong>éœ€åŠ å¼·è¨“ç·´ï¼</strong><br>éŒ¯é¡Œå·²åŠ å…¥å„ªå…ˆè¤‡ç¿’éšŠåˆ—ã€‚";
        }

        // ============================
        // ğŸŒŸ æ–°å¢ï¼šè¨ˆç®—ç¸½é«”é€²åº¦ ğŸŒŸ
        // ============================
        const masteryStats = calculateMastery();
        document.getElementById('mastery-percentage').textContent = `${masteryStats.percent}%`;
        document.getElementById('mastery-count-text').textContent = `å·²ç²¾é€š ${masteryStats.mastered} / ${masteryStats.total} å­— (é€£å°3æ¬¡ä»¥ä¸Š)`;
        // å‹•ç•«é¡¯ç¤ºé€²åº¦æ¢
        setTimeout(() => {
            document.getElementById('mastery-bar-fill').style.width = `${masteryStats.percent}%`;
        }, 300);

        // ç”ŸæˆéŒ¯é¡Œåˆ—è¡¨
        const reviewContainer = document.getElementById('review-container');
        reviewContainer.innerHTML = '';

        if (sessionMistakes.length === 0) {
            reviewContainer.innerHTML = '<div style="padding:15px; color:#bdc3c7;">ğŸ‰ å¤ªæ£’äº†ï¼æœ¬å±€å…¨å°ï¼</div>';
        } else {
            sessionMistakes.forEach(item => {
                const div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `
                    <span class="review-context">${item.context.replace(item.word, `<span style="color:var(--highlight-color)">${item.word}</span>`)}</span>
                    <br>
                    <span style="color:#7f8c8d; font-size:14px;">
                        èª¤è®€: <span style="color:var(--accent-color)">${item.wrong}</span> 
                        â†’ æ­£éŸ³: <span style="color:var(--success-color)">${item.pinyin}</span>
                    </span>
                `;
                reviewContainer.appendChild(div);
            });
        }
    }

    // æ˜Ÿç©ºèƒŒæ™¯å‹•ç•«
    function initStars() {
        const canvas = document.getElementById('star-canvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        let stars = [];
        for(let i=0; i<60; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 1.5,
                alpha: Math.random(),
                speed: Math.random() * 0.05
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            stars.forEach(star => {
                ctx.globalAlpha = star.alpha;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI*2);
                ctx.fill();
                star.y -= star.speed;
                if(star.y < 0) {
                    star.y = canvas.height;
                    star.x = Math.random() * canvas.width;
                }
            });
            requestAnimationFrame(draw);
        }
        draw();
    }

    // å•Ÿå‹•
    window.onload = () => {
        initStars();
        initGame();
    };

</script>
</body>
</html>
